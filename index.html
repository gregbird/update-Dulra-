<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dulra Management Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            width: calc(100% - 250px);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Simple transition effects */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .list-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-left-color: #16a34a; /* green-600 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-50">
        <div class="w-full max-w-md p-8 space-y-8 bg-white shadow-xl rounded-lg">
            <div class="flex flex-col items-center">
                <i class="fas fa-leaf text-5xl text-green-600"></i>
                <h2 class="mt-4 text-3xl font-bold text-center text-gray-900">
                    Project Dulra Platform
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Welcome back, please log in.
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div>
                    <label for="email-address" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input id="email-address" name="email" type="email" autocomplete="email" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500"
                        placeholder="helen@dulra.ie" value="helen@dulra.ie">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500"
                        placeholder="••••••••" value="admin"> <!-- Demo password -->
                </div>
                 <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900"> Remember me </label>
                    </div>
                    <div class="text-sm">
                        <a href="#" class="font-medium text-green-600 hover:text-green-500"> Forgot your password? </a>
                    </div>
                </div>
                <div>
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-sm font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all">
                        <i class="fas fa-lock mr-2 mt-0.5"></i>
                        Log In
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (hidden by default) -->
    <div id="app" class="flex h-screen hidden">
        <!-- Sidebar -->
        <aside class="sidebar bg-white shadow-lg flex flex-col p-4 fixed h-full">
            <div class="text-2xl font-bold text-green-700 flex items-center mb-8">
                <i class="fas fa-leaf mr-3"></i>
                <span>Dulra</span>
            </div>
            <nav class="flex flex-col space-y-1 flex-grow overflow-y-auto pr-2">
                <a href="#" id="home-link" class="flex items-center p-3 bg-green-100 text-green-800 rounded-lg font-semibold">
                    <i class="fas fa-home w-6 text-center"></i>
                    <span class="ml-4">Home</span>
                </a>
                <a href="#" id="dashboard-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-tachometer-alt w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Dashboard</span>
                </a>
                
                <!-- NEW: Tasks Link -->
                <a href="#" id="tasks-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-clipboard-list w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Tasks</span>
                </a>

                <!-- Year Section -->
                <div>
                    <button class="collapsible-btn w-full flex justify-between items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-alt w-6 text-center"></i>
                            <span class="ml-4 font-semibold">Project Year</span>
                        </div>
                        <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                    </button>
                    <div class="collapsible-content hidden pl-8 mt-1 space-y-1">
                        <a href="#" class="block p-2 text-sm text-gray-500 hover:bg-gray-100 rounded-md">2026</a>
                        <a href="#" class="block p-2 text-sm text-gray-500 hover:bg-gray-100 rounded-md">2025</a>
                        <a href="#" class="block p-2 text-sm text-gray-500 hover:bg-gray-100 rounded-md">2024</a>
                    </div>
                </div>

                <!-- Applications Section -->
                <div>
                    <button class="collapsible-btn w-full flex justify-between items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                        <div class="flex items-center">
                            <i class="fas fa-folder-plus w-6 text-center"></i>
                            <span class="ml-4 font-semibold">Applications</span>
                        </div>
                        <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                    </button>
                    <div class="collapsible-content hidden pl-8 mt-1 space-y-1">
                        <a href="#" class="block p-2 text-sm text-gray-500 hover:bg-gray-100 rounded-md">By County</a>
                        <a href="#" class="block p-2 text-sm text-gray-500 hover:bg-gray-100 rounded-md">By Action</a>
                    </div>
                </div>

                <!-- Implementation Section -->
                <a href="#" id="implementation-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                     <div class="flex items-center">
                        <i class="fas fa-tasks w-6 text-center"></i>
                        <span class="ml-4 font-semibold">Implementation</span>
                    </div>
                </a>

                <!-- Surveys Section -->
                <a href="#" id="surveys-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-poll w-6 text-center"></i>
                        <span class="ml-4 font-semibold">Surveys</span>
                    </div>
                </a>

                <!-- Assessments Section -->
                <a href="#" id="assessments-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-check w-6 text-center"></i>
                        <span class="ml-4 font-semibold">Assessments</span>
                    </div>
                </a>

                <!-- Communication Section -->
                <a href="#" id="communication-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-bullhorn w-6 text-center"></i>
                        <span class="ml-4 font-semibold">Communication</span>
                    </div>
                </a>

                <!-- Team Members Section -->
                <a href="#" id="team-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-users w-6 text-center"></i>
                        <span class="ml-4 font-semibold">Team Members</span>
                    </div>
                </a>

                <!-- Reports Section -->
                <div>
                    <button class="collapsible-btn w-full flex justify-between items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                        <div class="flex items-center">
                            <i class="fas fa-chart-pie w-6 text-center"></i>
                            <span class="ml-4 font-semibold">Reports</span>
                        </div>
                        <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                    </button>
                    <div class="collapsible-content hidden pl-4 mt-1 space-y-1">
                        <!-- Private Funders Sub-section -->
                        <div class="pl-4">
                             <button class="collapsible-btn w-full flex justify-between items-center p-2 text-gray-500 hover:bg-gray-100 rounded-lg text-left">
                                <span class="text-sm font-semibold">Private Funders</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                            </button>
                            <div class="collapsible-content hidden pl-6 mt-1 space-y-1">
                                <a href="#" class="block p-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded-md">County</a>
                                <a href="#" class="block p-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded-md">ESG Report</a>
                                <a href="#" class="block p-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded-md">CSRD Report</a>
                            </div>
                        </div>
                        <!-- Public Funders Sub-section -->
                        <div class="pl-4">
                             <button class="collapsible-btn w-full flex justify-between items-center p-2 text-gray-500 hover:bg-gray-100 rounded-lg text-left">
                                <span class="text-sm font-semibold">Public Funders</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                            </button>
                            <div class="collapsible-content hidden pl-6 mt-1 space-y-1">
                                <a href="#" class="block p-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded-md">County</a>
                                <a href="#" class="block p-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded-md">EU Restoration Targets</a>
                                <a href="#" class="block p-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded-md">EU Habitat Directive</a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="mt-auto p-4 bg-gray-50 rounded-lg text-center">
                <p class="text-sm">Welcome, <span class="font-bold">Helen</span>!</p>
                <p class="text-xs text-gray-500">HC Team Coordinator</p>
                <button id="logout-btn" class="text-xs text-red-500 hover:text-red-700 font-medium mt-2 hover:underline">Log Out</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content ml-[250px] flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-md shadow-sm p-4 sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <h1 id="page-title" class="text-2xl font-bold text-gray-700"></h1>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Search projects..." class="pl-10 pr-4 py-2 border rounded-full w-64 focus:ring-2 focus:ring-green-500 focus:outline-none">
                        </div>
                        <button id="add-project-btn" class="bg-green-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-700 transition-all shadow-md">
                            <i class="fas fa-plus mr-2"></i>New Project
                        </button>
                    </div>
                </div>
            </header>

            <!-- Dynamic Content Area -->
            <div id="content-area" class="p-6 flex-1 overflow-y-auto">
                <!-- Views will be rendered here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modals (hidden by default) -->
    <div id="new-project-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <!-- Modal Content -->
    </div>
    <div id="assessment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <!-- Modal Content -->
    </div>
    <div id="survey-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <!-- Modal Content -->
    </div>
    <div id="communication-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <!-- Modal Content -->
    </div>
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform -translate-y-10 transition-all duration-300">
        Message sent successfully!
    </div>


    <script>
        // --- DATA STORE ---
        // Mock database for the MVP
        
        const surveyTemplates = [
            { id: 1, name: 'Application', description: 'Initial application form for landowners.', questionCount: 8, icon: 'fa-folder-plus', questions: [] },
            { id: 2, name: 'Scorecard for Peatlands', description: 'Feedback survey for the ecological plan service.', questionCount: 6, icon: 'fa-feather-alt', questions: [] },
            { id: 3, name: 'Scorecard for Grasslands', description: 'Pre-implementation questions for pond projects.', questionCount: 7, icon: 'fa-water', questions: [] },
            { id: 4, name: 'Post Project Survey', description: 'General feedback survey for completed projects.', questionCount: 5, icon: 'fa-award', questions: [] },
            { 
                id: 5, 
                name: 'Scorecard for Woodland', 
                description: 'Detailed on-site assessment for wildlife ponds.', 
                questionCount: 15,
                icon: 'fa-vial',
                questions: [
                    { type: 'text', label: 'HC Participant' },
                    { type: 'date', label: 'Date of Visit' },
                    { type: 'text', label: 'Eircode' },
                    { type: 'text', label: 'Surveyor' },
                    { type: 'tel', label: 'Phone Number' },
                    { type: 'radio', label: 'Fixed Point Photo taken?', options: ['Yes', 'No'] },
                    { type: 'number', label: 'Size (m2)' },
                    { type: 'radio', label: 'Holding Water?', options: ['Yes', 'No'] },
                    { type: 'text', label: 'If no, is it Ephemeral or has it failed?' },
                    { type: 'radio', label: 'Plants', options: ['All native', 'Some non-native', 'Some invasive'] },
                    { type: 'textarea', label: 'Insects present during visit? If yes, which?' },
                    { type: 'textarea', label: 'Were you happy with the pond site visit? Was enough info given?' },
                    { type: 'radio', label: 'Did you utilise the resources (webinar, pond notes)?', options: ['Yes', 'No'] },
                    { type: 'radio', label: 'Are you happy with the way your pond has turned out?', options: ['Yes', 'No'] },
                    { type: 'checkbox', label: 'Most Important to you:', options: ['Money', 'Pond Advisor', 'Resources'] }
                ] 
            },
            { 
                id: 6, 
                name: 'Woodland Assessment', 
                description: 'On-site assessment for mini woodland projects.', 
                questionCount: 9,
                icon: 'fa-tree',
                questions: [
                    { type: 'text', label: 'HC Participant' },
                    { type: 'date', label: 'Date of Visit' },
                    { type: 'text', label: 'Eircode & Phone' },
                    { type: 'text', label: 'Surveyor' },
                    { type: 'number', label: 'Companion Species: % survival rating' },
                    { type: 'number', label: 'Burren Pine: % survival rating' },
                    { type: 'checkbox', label: 'Additional inputs:', options: ['Stakes', 'Fencing', 'Tree Guards', 'Other'] },
                    { type: 'checkbox', label: 'Management:', options: ['Trampling', 'Mowing', 'Mulching', 'Spraying', 'None', 'Other'] },
                    { type: 'textarea', label: 'Additional Comments?' }
                ] 
            },
            { 
                id: 7, 
                name: 'Rossbehy Assessment', 
                description: 'Detailed on-site assessment for Rossbehy coastal projects.', 
                questionCount: 12,
                icon: 'fa-water',
                questions: [
                    { type: 'text', label: 'HC Participant' },
                    { type: 'date', label: 'Date of Visit' },
                    { type: 'text', label: 'Eircode' },
                    { type: 'text', label: 'Surveyor' },
                    { type: 'radio', label: 'Fixed Point Photo taken?', options: ['Yes', 'No'] },
                    { type: 'number', label: 'Area Surveyed (m2)' },
                    { type: 'text', label: 'Primary Habitat Type', placeholder: 'e.g., Dune system, Salt marsh' },
                    { type: 'checkbox', label: 'Pressures Observed', options: ['Coastal Erosion', 'Invasive Species (e.g., Sea Buckthorn)', 'Pollution', 'Recreation Impact', 'None'] },
                    { type: 'textarea', label: 'Invasive Species Details' },
                    { type: 'radio', label: 'Overall Condition', options: ['Good', 'Moderate', 'Poor'] },
                    { type: 'textarea', label: 'Management Recommendations' },
                    { type: 'textarea', label: 'Additional Comments?' }
                ] 
            }
        ];

        const teamMembers = [
            { id: 1, name: 'Peter Jones', role: 'Hydrologist', email: 'peter.jones@dulra.ie', phone: '353871112233', assignments: [ { projectId: 1, status: 'Pending' }, { projectId: 4, status: 'Waiting for Information' }, { projectId: 15, status: 'Completed' }, { projectId: 22, status: 'Pending' } ] },
            { id: 2, name: 'Maria Garcia', role: 'Ecologist', email: 'maria.garcia@dulra.ie', phone: '353872223344', assignments: [ { projectId: 2, status: 'Completed' }, { projectId: 8, status: 'Pending' }, { projectId: 18, status: 'Completed' } ] },
            { id: 3, name: 'John Doe', role: 'Assessor', email: 'john.doe@dulra.ie', phone: '353873334455', assignments: [ { projectId: 3, status: 'Completed' }, { projectId: 11, status: 'Waiting for Information' } ] },
            { id: 4, name: 'Aoife Murphy', role: 'Ecologist', email: 'aoife.murphy@dulra.ie', phone: '353864445566', assignments: [ { projectId: 5, status: 'Pending' }, { projectId: 14, status: 'Pending' } ] },
            { id: 5, name: 'Cian O\'Kelly', role: 'Hydrologist', email: 'cian.okelly@dulra.ie', phone: '353855556677', assignments: [ { projectId: 6, status: 'Completed' }, { projectId: 25, status: 'Waiting for Information' } ] },
            { id: 6, name: 'Sinead Walsh', role: 'Assessor', email: 'sinead.walsh@dulra.ie', phone: '353876667788', assignments: [ { projectId: 7, status: 'Pending' }, { projectId: 17, status: 'Completed' } ] },
            { id: 7, name: 'Eoin Lynch', role: 'Ecologist', email: 'eoin.lynch@dulra.ie', phone: '353877778899', assignments: [ { projectId: 9, status: 'Completed' }, { projectId: 28, status: 'Pending' } ] },
            { id: 8, name: 'Fionnuala Ryan', role: 'Hydrologist', email: 'fionnuala.ryan@dulra.ie', phone: '353868889900', assignments: [ { projectId: 10, status: 'Waiting for Information' }, { projectId: 31, status: 'Completed' } ] },
            { id: 9, name: 'Declan Byrne', role: 'Assessor', email: 'declan.byrne@dulra.ie', phone: '353859990011', assignments: [ { projectId: 12, status: 'Pending' }, { projectId: 20, status: 'Completed' } ] },
            { id: 10, name: 'Roisin Doyle', role: 'Ecologist', email: 'roisin.doyle@dulra.ie', phone: '353870001122', assignments: [ { projectId: 13, status: 'Completed' }, { projectId: 24, status: 'Pending' } ] }
        ];

        // Helper function to generate realistic project data
        function generateProjects() {
            const firstNames = ['Liam', 'Olivia', 'Noah', 'Emma', 'Oliver', 'Ava', 'Elijah', 'Charlotte', 'William', 'Sophia', 'James', 'Amelia', 'Benjamin', 'Isabella', 'Lucas', 'Mia'];
            const lastNames = ['Murphy', 'Kelly', 'Byrne', 'Ryan', 'O\'Brien', 'Walsh', 'O\'Connor', 'Doyle', 'McCarthy', 'Gallagher', 'Lynch', 'Murray'];
            const counties = ['Kerry', 'Cork', 'Galway', 'Clare', 'Limerick', 'Tipperary', 'Mayo', 'Donegal'];
            // Updated Action Types
            const actionTypes = ['Fencing', 'Blocking Drains', 'Woodland', 'Sphagnum Moss', 'Hedgerow'];

            let projectList = [
                // Keep original diverse-status projects for context - UPDATED with new action types
                 { id: 1, landowner: 'David Miller', county: 'Kerry', eircode: 'V93 AB12', phone: '353871234567', actionType: 'Blocking Drains', status: 'Implementation', startDate: '2025-08-15', specialist: 'Peter Jones (Hydrologist)', details: 'Blocking drains in the lower meadow to enhance local biodiversity and re-wet the area.', assessments: [], survey: { status: 'Pending', data: null }, activityLog: [{ date: '2025-08-20', activity: 'Hydrologist assigned: Peter Jones' }, { date: '2025-08-15', activity: 'Application approved. Project initiated.' }] },
                 { id: 2, landowner: 'Sarah Chen', county: 'Cork', eircode: 'T23 CD34', phone: '353872345678', actionType: 'Woodland', status: 'Data Collection', startDate: '2025-07-01', specialist: 'Maria Garcia (Ecologist)', details: 'A comprehensive ecological plan for a new 10-acre mixed woodland.', assessments: [{ assessor: 'Maria Garcia', date: '2025-09-10', notes: 'Site visit complete. Excellent potential for native species reintroduction. Soil samples taken.', photos: 2, location: '52.05, -9.51' }], survey: { status: 'Pending', data: null }, activityLog: [{ date: '2025-09-10', activity: 'On-site assessment completed by Maria Garcia.' }, { date: '2025-07-05', activity: 'Ecologist created 10-page plan and delivered to landowner.' }, { date: '2025-07-01', activity: 'Project initiated.' }] },
                 { id: 3, landowner: 'Tom O\'Sullivan', county: 'Limerick', eircode: 'V94 EF56', phone: '353873456789', actionType: 'Hedgerow', status: 'Complete', startDate: '2025-04-10', specialist: 'HC Team', details: 'Planting of 300m of native Irish hedgerow.', assessments: [{ assessor: 'John Doe', date: '2025-09-18', notes: 'Post-action assessment shows 95% plant survival rate. Good growth observed.', photos: 5, location: '52.14, -9.52' }], survey: { status: 'Complete', data: { satisfaction: 5, feedback: 'The process was smooth and the advice was very helpful!' } }, activityLog: [{ date: '2025-09-20', activity: 'Participant survey completed.' }, { date: '2025-09-18', activity: 'On-site assessment completed by John Doe.' }, { date: '2025-04-22', activity: 'Landowner planted hedgerow.' }, { date: '2025-04-10', activity: 'Project initiated.' }] },
                 { id: 4, landowner: 'Grace Kelly', county: 'Clare', eircode: 'V95 GH78', phone: '353874567890', actionType: 'Fencing', status: 'Application Review', startDate: '2025-09-21', specialist: 'N/A', details: 'Proposal for fencing off a small pond near an existing stream.', assessments: [], survey: { status: 'Not Sent', data: null }, activityLog: [{ date: '2025-09-21', activity: 'Landowner submitted application.' }] }
            ];

            const eircodePrefixes = {
                'Kerry': 'V93', 'Cork': 'T23', 'Galway': 'H91', 'Clare': 'V95', 'Limerick': 'V94', 'Tipperary': 'E41', 'Mayo': 'F23', 'Donegal': 'F92'
            };
            const chars = 'ABCDEFHKNPRSTVWXYZ123456789';

            for (let i = 5; i <= 34; i++) {
                const fName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const county = counties[Math.floor(Math.random() * counties.length)];
                const action = actionTypes[Math.floor(Math.random() * actionTypes.length)];
                const month = Math.floor(Math.random() * 8) + 1; // Jan to Aug
                
                let randomEircode = eircodePrefixes[county] + ' ';
                for(let j=0; j<4; j++) randomEircode += chars.charAt(Math.floor(Math.random() * chars.length));

                projectList.push({
                    id: i,
                    landowner: `${fName} ${lName}`,
                    county: county,
                    eircode: randomEircode,
                    phone: `35386${Math.floor(1000000 + Math.random() * 9000000)}`,
                    actionType: action,
                    status: 'Implementation',
                    startDate: `2025-0${month}-${Math.floor(Math.random() * 28) + 1}`,
                    specialist: action === 'Blocking Drains' ? 'Peter Jones (Hydrologist)' : (action === 'Woodland' ? 'Maria Garcia (Ecologist)' : 'HC Team'),
                    details: `Project in implementation phase for ${action.toLowerCase()}.`,
                    assessments: [],
                    survey: { status: 'Not Sent', data: null },
                    activityLog: [
                         { date: `2025-0${month}-01`, activity: 'Application approved. Project initiated.' }
                    ]
                });
            }
            return projectList;
        }

        let projects = generateProjects();
        
        // Global object to hold chart instances
        let chartInstances = {};

        // --- GLOBAL STATE ---
        const state = {
            currentView: 'overview', // 'overview', 'dashboard', 'tasks', 'projectDetail', 'team', 'surveys'
            dashboardView: 'list', // 'list' or 'analytics'
            overviewView: 'platform', // 'platform' or 'structure'
            tasksView: 'actions', // 'actions' or 'assessments'
            currentProjectId: null,
            filterText: '',
        };

        // --- DOM ELEMENTS ---
        let contentArea, pageTitle, searchInput, homeLink, dashboardLink, tasksLink, addProjectBtn, surveysLink, implementationLink, assessmentsLink, communicationLink, teamLink, loginPage, appContainer, loginForm, logoutBtn;

        // --- STATUS STYLES MAPPING ---
        const statusStyles = {
            'Application Review': 'bg-yellow-100 text-yellow-800',
            'Implementation': 'bg-blue-100 text-blue-800',
            'Data Collection': 'bg-purple-100 text-purple-800',
            'Complete': 'bg-green-100 text-green-800',
        };

        const assignmentStatusStyles = {
            'Waiting for Information': 'bg-yellow-100 text-yellow-800',
            'Pending': 'bg-blue-100 text-blue-800',
            'Completed': 'bg-green-100 text-green-800',
        };

        const iconMap = {
            'Fencing': 'fas fa-grip-horizontal',
            'Blocking Drains': 'fas fa-trowel',
            'Woodland': 'fas fa-tree',
            'Sphagnum Moss': 'fas fa-seedling',
            'Hedgerow': 'fas fa-leaf',
            // Old icons left for survey templates
            'Wildlife Pond': 'fas fa-water',
            'Plan for Nature': 'fas fa-feather-alt',
            'Mini Woodland': 'fas fa-tree',
        };

        // --- RENDER FUNCTIONS ---

        /**
         * Sets the active link in the sidebar
         */
        function setActiveLink(activeLink) {
            // Remove active styles from all main links
            [homeLink, dashboardLink, tasksLink, surveysLink, implementationLink, assessmentsLink, communicationLink, teamLink].forEach(link => {
                if (link) { // Check if link exists
                    link.classList.remove('bg-green-100', 'text-green-800', 'font-semibold');
                    link.classList.add('text-gray-600', 'hover:bg-gray-200');
                }
            });
            // Add active styles to the target link
            if (activeLink) {
                activeLink.classList.add('bg-green-100', 'text-green-800', 'font-semibold');
                activeLink.classList.remove('text-gray-600', 'hover:bg-gray-200');
            }
        }

        /**
         * Renders the main overview/home page.
         */
        function renderOverviewPage() {
            state.currentView = 'overview';
            state.currentProjectId = null;
            pageTitle.textContent = 'Home';
            addProjectBtn.classList.add('hidden');
            setActiveLink(homeLink);

            contentArea.innerHTML = `
                <div class="mb-4 border-b border-gray-200">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="overview-tabs">
                        <li class="mr-2">
                            <button class="overview-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="platform">
                                <i class="fas fa-rocket mr-2"></i>Platform Overview
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="overview-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="structure">
                                <i class="fas fa-sitemap mr-2"></i>Project Structure
                            </button>
                        </li>
                    </ul>
                </div>
                <div id="overview-content">
                    <!-- Content will be injected here -->
                </div>
            `;
            
            // Set active tab and render content
            updateOverviewView(state.overviewView);
        }

        /**
         * Updates the overview page to show the selected tab's content
         */
        function updateOverviewView(view) {
            state.overviewView = view;
            
            // Update tab styles
            document.querySelectorAll('.overview-tab').forEach(tab => {
                if (tab.dataset.view === view) {
                    tab.classList.add('border-green-600', 'text-green-600');
                    tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                } else {
                    tab.classList.remove('border-green-600', 'text-green-600');
                    tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                }
            });

            // Render content based on view
            if (view === 'platform') {
                renderOverviewPlatformContent();
            } else {
                renderOverviewStructureContent();
            }
        }

        /**
         * Renders the platform overview content
         */
        function renderOverviewPlatformContent() {
            const overviewContent = document.getElementById('overview-content');
            if (!overviewContent) return;

            overviewContent.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">The Project Dulra Management Platform</h2>
                    <p class="text-lg text-gray-600 mb-8">A comprehensive solution designed to bring efficiency and scalability to your environmental projects. This platform is built on six core modules:</p>
                    <div class="space-y-8">
                        <!-- Module 1 -->
                        <div class="flex items-start">
                            <i class="fas fa-user-plus fa-2x text-green-600 w-12 text-center mt-1"></i>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold mb-1">1. Participant Onboarding & Management</h3>
                                <p class="text-gray-600 mb-2">Automate the sign-up process from the start.</p>
                                <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                    <li><strong>Configurable Sign-Up Forms:</strong> Participants apply and submit data through a guided digital form.</li>
                                    <li><strong>Backend Approval System:</strong> Your team can approve or tag participants based on pre-set criteria.</li>
                                    <li><strong>Application Progress Notifications:</strong> Automatic updates keep participants informed.</li>
                                </ul>
                            </div>
                        </div>
                        <!-- Module 2 -->
                        <div class="flex items-start">
                            <i class="fas fa-tasks fa-2x text-green-600 w-12 text-center mt-1"></i>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold mb-1">2. Workflow Management</h3>
                                <p class="text-gray-600 mb-2">Get a real-time, comprehensive view of your entire operation.</p>
                                <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                    <li><strong>Real-Time Dashboard:</strong> Shows the live status, key metrics, and progress of all projects.</li>
                                    <li><strong>Customizable Workflows:</strong> Organise surveys, actions, and assign team members.</li>
                                    <li><strong>Workload Visibility:</strong> Views show the current workload and capacity of individual team members.</li>
                                </ul>
                            </div>
                        </div>
                        <!-- Module 3 -->
                        <div class="flex items-start">
                            <i class="fas fa-database fa-2x text-green-600 w-12 text-center mt-1"></i>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold mb-1">3. Data Management</h3>
                                <p class="text-gray-600 mb-2">Efficient data collection, verification, and storage for all field activities.</p>
                                <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                    <li><strong>Digital Data Collection:</strong> Create, manage, and deploy digital surveys and on-site assessment forms from a phone or tablet.</li>
                                    <li><strong>Eliminate Paperwork:</strong> Data is captured instantly and syncs directly to relevant project files.</li>
                                    <li><strong>Monitoring & Audit Trail:</strong> Connect to monitoring tools and maintain an audit trail for all data.</li>
                                </ul>
                            </div>
                        </div>
                        <!-- Module 4 -->
                        <div class="flex items-start">
                            <i class="fas fa-chart-pie fa-2x text-green-600 w-12 text-center mt-1"></i>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold mb-1">4. Reporting & Impact Generation</h3>
                                <p class="text-gray-600 mb-2">Turn raw data into professional, stakeholder-ready reports.</p>
                                <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                    <li><strong>Template-Based Reporting:</strong> Instantly generate reports for ESG, CSRD, EU Restoration Targets, etc.</li>
                                    <li><strong>Automatic Data Aggregation:</strong> The platform automatically pulls and aggregates data from all modules.</li>
                                </ul>
                            </div>
                        </div>
                        <!-- Module 5 -->
                        <div class="flex items-start">
                            <i class="fas fa-bullhorn fa-2x text-green-600 w-12 text-center mt-1"></i>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold mb-1">5. Integrated Communications Suite</h3>
                                <p class="text-gray-600 mb-2">Engage with your participants efficiently and effectively.</p>
                                <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                    <li><strong>Targeted Bulk Messaging:</strong> Send individual or filtered bulk Emails and WhatsApp messages.</li>
                                    <li><strong>Filter-Based Sending:</strong> Use filters (like action type or project status) to reach the right people.</li>
                                </ul>
                            </div>
                        </div>
                        <!-- Module 6 -->
                        <div class="flex items-start">
                            <i class="fas fa-map-marked-alt fa-2x text-green-600 w-12 text-center mt-1"></i>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold mb-1">6. Project Visualisation (Phase 2)</h3>
                                <p class="text-gray-600 mb-2">Create a public-facing interactive map and key impact dashboard.</p>
                                <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                    <li><strong>Public-Facing Showcase:</strong> Showcase projects to enable stakeholders to explore and assess projects for funding.</li>
                                    <li><strong>Provide Context:</strong> Provides geographic and impact context to your projects.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the project structure content
         */
        function renderOverviewStructureContent() {
            const overviewContent = document.getElementById('overview-content');
            if (!overviewContent) return;
            
            overviewContent.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">The Hare's Corner - Structure</h2>
                    <div class="space-y-2">
                        <!-- Action Implementation -->
                        <div>
                            <button class="collapsible-btn w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-left">
                                <span class="font-semibold text-lg"><i class="fas fa-tasks w-8 text-center text-gray-500 mr-3"></i>Action Implementation</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div class="collapsible-content hidden pl-16 py-2 space-y-1 text-gray-600">
                                <p>Wildlife Pond</p>
                                <p>Plan for Nature</p>
                                <p>Mini Woodland</p>
                                <p>Other</p>
                            </div>
                        </div>
                        <!-- Application Approval Process -->
                        <div>
                            <button class="collapsible-btn w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-left">
                                <span class="font-semibold text-lg"><i class="fas fa-folder-plus w-8 text-center text-gray-500 mr-3"></i>Application Approval Process</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div class="collapsible-content hidden pl-16 py-2 space-y-1 text-gray-600">
                                <p>Online Application Form</p>
                                <p>Internal Review & Scoring</p>
                                <p>Approval/Rejection Comms</p>
                            </div>
                        </div>
                        <!-- Participant Communication Strategy -->
                        <div>
                            <button class="collapsible-btn w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-left">
                                <span class="font-semibold text-lg"><i class="fas fa-bullhorn w-8 text-center text-gray-500 mr-3"></i>Participant Communication Strategy</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div class="collapsible-content hidden pl-16 py-2 space-y-1 text-gray-600">
                                <p>Bulk Communication (Email, WhatsApp)</p>
                                <p>Individual Communication (Project Milestones)</p>
                                <p>Resource Hub (Guides, Webinars)</p>
                            </div>
                        </div>
                        <!-- Data Collection & Reporting -->
                        <div>
                            <button class="collapsible-btn w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-left">
                                <span class="font-semibold text-lg"><i class="fas fa-database w-8 text-center text-gray-500 mr-3"></i>Data Collection & Reporting</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div class="collapsible-content hidden pl-16 py-2 space-y-1 text-gray-600">
                                <p>Participant Surveys (Google Forms)</p>
                                <div>
                                    <button class="collapsible-btn w-full flex justify-between items-center p-2 text-gray-600 text-left">
                                        <span class="font-semibold">On-Site Assessments</span>
                                        <i class="fas fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                                    </button>
                                    <div class="collapsible-content hidden pl-8 py-2 space-y-1 text-sm">
                                        <p>Pond Assessment Sheet</p>
                                        <p>Woodland Assessment Sheet</p>
                                    </div>
                                </div>
                                <div>
                                    <button class="collapsible-btn w-full flex justify-between items-center p-2 text-gray-600 text-left">
                                        <span class="font-semibold">Funder Reporting</span>
                                        <i class="fas fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                                    </button>
                                    <div class="collapsible-content hidden pl-8 py-2 space-y-1 text-sm">
                                        <p>Private Funders (ESG, CSRD)</p>
                                        <p>Public Funders (EU Targets)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Financials -->
                        <div>
                            <button class="collapsible-btn w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-left">
                                <span class="font-semibold text-lg"><i class="fas fa-euro-sign w-8 text-center text-gray-500 mr-3"></i>Financials</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div class="collapsible-content hidden pl-16 py-2 space-y-1 text-gray-600">
                                <p>Grant Management</p>
                                <p>Payment Processing</p>
                            </div>
                        </div>
                        <!-- Team Members -->
                        <div>
                            <button class="collapsible-btn w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-left">
                                <span class="font-semibold text-lg"><i class="fas fa-users w-8 text-center text-gray-500 mr-3"></i>Team Members</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div class="collapsible-content hidden pl-16 py-2 space-y-1 text-gray-600">
                                <p>Coordinators</p>
                                <p>Ecologists</p>
                                <p>Hydrologists</p>
                                <p>Assessors</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the main dashboard view with project cards.
         */
        function renderDashboard() {
            state.currentView = 'dashboard';
            state.currentProjectId = null;
            pageTitle.textContent = 'Projects Dashboard';
            setActiveLink(dashboardLink);

            // Create tab structure
            contentArea.innerHTML = `
                <div class="mb-4 border-b border-gray-200">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="dashboard-tabs">
                        <li class="mr-2">
                            <button class="dashboard-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="list">
                                <i class="fas fa-list mr-2"></i>Project List
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="dashboard-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="analytics">
                                <i class="fas fa-chart-line mr-2"></i>Analytics
                            </button>
                        </li>
                    </ul>
                </div>
                <div id="dashboard-content">
                    <!-- Content will be injected here -->
                </div>
            `;

            // Set active tab and render content
            updateDashboardView(state.dashboardView);
        }

        /**
         * Updates the dashboard to show the selected tab's content
         */
        function updateDashboardView(view) {
            state.dashboardView = view;
            
            // Update tab styles
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                if (tab.dataset.view === view) {
                    tab.classList.add('border-green-600', 'text-green-600');
                    tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                } else {
                    tab.classList.remove('border-green-600', 'text-green-600');
                    tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                }
            });

            // Render content based on view
            if (view === 'list') {
                searchInput.classList.remove('hidden');
                addProjectBtn.classList.remove('hidden');
                renderProjectList();
            } else {
                searchInput.classList.add('hidden');
                addProjectBtn.classList.add('hidden');
                renderAnalyticsDashboard();
            }
        }

        /**
         * Renders the project list view (formerly renderDashboard)
         */
        function renderProjectList() {
            const dashboardContent = document.getElementById('dashboard-content');
            if (!dashboardContent) return;

            const filteredProjects = projects.filter(p => 
                p.landowner.toLowerCase().includes(state.filterText.toLowerCase()) ||
                p.actionType.toLowerCase().includes(state.filterText.toLowerCase()) ||
                p.county.toLowerCase().includes(state.filterText.toLowerCase())
            );

            if (filteredProjects.length === 0) {
                dashboardContent.innerHTML = `<div class="text-center py-16"><i class="fas fa-folder-open fa-3x text-gray-400 mb-4"></i><h2 class="text-xl font-semibold text-gray-600">No projects found.</h2><p class="text-gray-500">Try adjusting your search or add a new project.</p></div>`;
                return;
            }

            const projectListHeader = `
                <div class="px-4 py-2 bg-gray-50 grid grid-cols-10 gap-4 text-xs font-bold text-gray-500 uppercase rounded-t-lg">
                    <div class="col-span-3">Landowner</div>
                    <div class="col-span-2">County</div>
                    <div class="col-span-3">Action Type</div>
                    <div class="col-span-2">Status</div>
                </div>
            `;
            
            // FIX: Removed onclick, added data-project-id
            const projectListItems = filteredProjects.map(p => `
                <div class="list-item-card bg-white px-4 py-3 grid grid-cols-10 gap-4 items-center border-b border-l-4 border-transparent cursor-pointer transition-all" data-project-id="${p.id}">
                    <div class="col-span-3 font-semibold text-gray-800">${p.landowner}</div>
                    <div class="col-span-2 text-sm text-gray-600">${p.county}</div>
                    <div class="col-span-3 text-sm text-gray-600 flex items-center">
                        <i class="${iconMap[p.actionType] || 'fas fa-leaf'} mr-3 text-gray-400 w-4 text-center"></i>
                        ${p.actionType}
                    </div>
                    <div class="col-span-2">
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusStyles[p.status] || 'bg-gray-100 text-gray-800'}">${p.status}</span>
                    </div>
                </div>
            `).join('');

            dashboardContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-500">Showing ${filteredProjects.length} projects.</p>
                    <!-- This button was removed in a previous fix, but is in the user's file. I'll remove it again for consistency with the new "Home" page tabs. -->
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    ${projectListHeader}
                    <div class="max-h-[75vh] overflow-y-auto">
                        ${projectListItems}
                    </div>
                </div>`;
        }
        
        /**
         * Renders the new Analytics Dashboard view
         */
        function renderAnalyticsDashboard() {
            const dashboardContent = document.getElementById('dashboard-content');
            if (!dashboardContent) return;

            // Destroy old charts if they exist
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            dashboardContent.innerHTML = `
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-sm font-medium text-gray-500">Total Applications</h3>
                        <p class="text-3xl font-bold text-gray-800 mt-2">1,072</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-sm font-medium text-gray-500">Eligible Applicants</h3>
                        <p class="text-3xl font-bold text-gray-800 mt-2">1,041</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-sm font-medium text-gray-500">Total Actions Applied For</h3>
                        <p class="text-3xl font-bold text-gray-800 mt-2">3,068</p>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-lg font-semibold mb-4">Applications by County</h3>
                        <div class="h-80"><canvas id="applications-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-lg font-semibold mb-4">Total Actions Applied For</h3>
                        <div class="h-80 flex justify-center"><canvas id="actions-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">Applicant Demographics (Eligible)</h3>
                        <div class="h-80 flex justify-center"><canvas id="demographics-chart"></canvas></div>
                    </div>
                </div>
            `;

            // Create charts
            createApplicationsChart();
            createActionsChart();
            createDemographicsChart();
        }

        /**
         * Creates the Applications by County bar chart
         */
        function createApplicationsChart() {
            const ctx = document.getElementById('applications-chart')?.getContext('2d');
            if (!ctx) return;

            const data = {
                labels: ['Kerry', 'Cork', 'Mayo', 'Limerick', 'Donegal', 'Roscommon', 'Sligo'],
                datasets: [
                    {
                        label: 'Applications',
                        data: [153, 51, 303, 121, 199, 86, 159],
                        backgroundColor: 'rgba(16, 163, 74, 0.6)', // green-600
                        borderColor: 'rgba(16, 163, 74, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Eligible',
                        data: [150, 50, 295, 113, 198, 81, 154],
                        backgroundColor: 'rgba(147, 197, 253, 0.6)', // blue-300
                        borderColor: 'rgba(147, 197, 253, 1)',
                        borderWidth: 1
                    }
                ]
            };

            chartInstances.applications = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        /**
         * Creates the Total Actions Applied For donut chart
         */
        function createActionsChart() {
            const ctx = document.getElementById('actions-chart')?.getContext('2d');
            if (!ctx) return;

            const data = {
                labels: ['Fencing', 'Blocking Drains', 'Woodland', 'Sphagnum Moss', 'Hedgerow'],
                datasets: [{
                    label: 'Total Actions',
                    data: [727, 416, 536, 735, 654], // Manually summed from CSVs
                    backgroundColor: [
                        'rgba(52, 211, 153, 0.7)', // emerald-400
                        'rgba(59, 130, 246, 0.7)', // blue-500
                        'rgba(16, 163, 74, 0.7)',  // green-600
                        'rgba(168, 85, 247, 0.7)', // purple-500
                        'rgba(239, 68, 68, 0.7)'   // red-500
                    ],
                    hoverOffset: 4
                }]
            };

            chartInstances.actions = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        /**
         * Creates the Applicant Demographics pie chart
         */
        function createDemographicsChart() {
            const ctx = document.getElementById('demographics-chart')?.getContext('2d');
            if (!ctx) return;

            const data = {
                labels: ['Dairy', 'Tilage', 'ACRES Co OP'],
                datasets: [{
                    label: 'Applicant Demographics',
                    data: [738, 86, 216], // From 'Applicant demographics.csv' - 'All' column
                    backgroundColor: [
                        'rgba(251, 146, 60, 0.7)', // orange-400
                        'rgba(132, 204, 22, 0.7)', // lime-500
                        'rgba(34, 197, 94, 0.7)'  // green-500
                    ],
                    hoverOffset: 4
                }]
            };

            chartInstances.demographics = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        /**
         * Renders the detailed view for a single project.
         * (RESTORED FUNCTION)
         */
        function renderProjectDetail(projectId) {
            state.currentView = 'projectDetail';
            state.currentProjectId = projectId;
            addProjectBtn.classList.add('hidden');
            // Note: No sidebar link is active when in a detail view
            setActiveLink(null);

            const project = projects.find(p => p.id === projectId);
            if (!project) {
                renderDashboard(); // Fallback if project not found
                return;
            }

            pageTitle.textContent = `Project: ${project.landowner}`;

            // --- Render functions for sub-components ---
            const renderOverview = () => `
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h3 class="font-bold text-lg mb-4">Project Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <div><strong class="text-gray-500 block">Landowner:</strong> ${project.landowner}</div>
                        <div><strong class="text-gray-500 block">County:</strong> ${project.county}</div>
                        <div><strong class="text-gray-500 block">Eircode:</strong> ${project.eircode}</div>
                        <div><strong class="text-gray-500 block">Action Type:</strong> ${project.actionType}</div>
                        <div><strong class="text-gray-500 block">Start Date:</strong> ${project.startDate}</div>
                        <div><strong class="text-gray-500 block">Assigned Specialist:</strong> ${project.specialist}</div>
                        <div class="lg:col-span-3"><strong class="text-gray-500 block">Details:</strong> ${project.details}</div>
                    </div>
                </div>
            `;

             const renderActions = () => {
                // Updated to check for 'Blocking Drains' as the hydrologist-related action
                const reportAttachment = project.actionType === 'Blocking Drains' ? `
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-lg mb-4">Attached Documents</h3>
                        <a href="#" class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100">
                            <i class="fas fa-file-pdf text-red-500 text-xl mr-3"></i>
                            <div>
                                <p class="font-semibold">Hydrologist_Report.pdf</p>
                                <p class="text-xs text-gray-500">1.2 MB - Uploaded 2025-08-20</p>
                            </div>
                        </a>
                    </div>
                ` : '';

                return `
                    <div class="space-y-6">
                         <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <h3 class="font-bold text-lg mb-4">Communication</h3>
                            <button onclick="window.open('https://wa.me/${project.phone}', '_blank')" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center">
                                <i class="fab fa-whatsapp text-xl mr-3"></i> Message Landowner via WhatsApp
                            </button>
                        </div>
                        ${reportAttachment}
                    </div>
                   `;
            };

            const renderAssessments = () => {
                const assessmentItems = project.assessments.length > 0 ? project.assessments.map(a => `
                    <div class="border-b last:border-b-0 py-3">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold">${a.assessor}</p>
                            <p class="text-sm text-gray-500">${a.date}</p>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${a.notes}</p>
                        <div class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-camera mr-1"></i> ${a.photos} photos | <i class="fas fa-map-marker-alt ml-3 mr-1"></i> ${a.location}
                        </div>
                    </div>`).join('') : '<p class="text-sm text-gray-500 py-4 text-center">No assessments recorded yet.</p>';
                
                return `
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">On-Site Assessments</h3>
                            <button class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-blue-600" onclick="openAssessmentModal()">
                                <i class="fas fa-plus mr-1"></i> Add Assessment
                            </button>
                        </div>
                        <div class="max-h-60 overflow-y-auto pr-2">${assessmentItems}</div>
                    </div>`;
            };

            const renderSurvey = () => {
                let surveyContent = '';
                if (project.survey.status === 'Complete') {
                    surveyContent = `<div class="bg-green-50 p-4 rounded-md">
                        <p class="font-semibold text-green-800">Survey Completed</p>
                        <p class="text-sm mt-1"><strong>Satisfaction:</strong> ${'⭐'.repeat(project.survey.data.satisfaction)}</p>
                        <p class="text-sm mt-1"><strong>Feedback:</strong> "${project.survey.data.feedback}"</p>
                    </div>`;
                } else if (project.survey.status === 'Pending') {
                     surveyContent = `<div class="flex items-center justify-between">
                        <p class="text-sm text-yellow-700">Survey sent to landowner. Awaiting response.</p>
                        <button class="text-sm text-blue-600 hover:underline" onclick="openSurveyModal(true)">Simulate Completion</button>
                     </div>`;
                } else {
                    surveyContent = `<div class="flex items-center justify-between">
                        <p class="text-sm text-gray-600">Participant survey has not been sent yet.</p>
                        <button class="bg-gray-200 text-gray-800 px-3 py-1 text-sm rounded-md font-semibold hover:bg-gray-300" onclick="sendSurvey(${project.id})">
                            <i class="fas fa-paper-plane mr-2"></i>Send Survey
                        </button>
                    </div>`;
                }
                return `<div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h3 class="font-bold text-lg mb-4">Participant Survey</h3>
                    ${surveyContent}
                </div>`;
            };

            const renderActivityLog = () => {
                const logItems = project.activityLog.map(log => `
                    <div class="flex items-start py-2">
                        <div class="w-2 h-2 bg-gray-300 rounded-full mt-1.5 mr-3"></div>
                        <div>
                            <p class="text-sm">${log.activity}</p>
                            <p class="text-xs text-gray-400">${log.date}</p>
                        </div>
                    </div>`).join('');
                return `
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-lg mb-2">Activity Log</h3>
                        <div class="max-h-96 overflow-y-auto pr-2">${logItems}</div>
                    </div>`;
            };

            contentArea.innerHTML = `
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="xl:col-span-2 space-y-6">
                        ${renderOverview()}
                        ${renderAssessments()}
                        ${renderSurvey()}
                    </div>
                    <div class="space-y-6">
                        ${renderActions()}
                        ${renderActivityLog()}
                    </div>
                </div>
            `;
        }

        /**
         * Renders the survey templates management page.
         * (RESTORED FUNCTION)
         */
        function renderSurveysPage() {
            state.currentView = 'surveys';
            state.currentProjectId = null;
            pageTitle.textContent = 'Survey Templates';
            addProjectBtn.classList.add('hidden'); // Or change to "+ Create Survey" button logic
            setActiveLink(surveysLink);

            const surveyCards = surveyTemplates.map(template => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col hover:shadow-lg transition-shadow">
                    <div class="flex-grow">
                        <div class="flex items-center text-green-600 mb-3">
                            <i class="fas ${template.icon || 'fa-poll'} fa-lg mr-3"></i>
                            <h3 class="font-bold text-lg text-gray-800">${template.name}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">${template.description}</p>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500 pt-4 border-t">
                        <span>${template.questionCount} Questions</span>
                        <div>
                            <a href="#" class="hover:text-green-600 mr-3"><i class="fas fa-edit mr-1"></i> Edit</a>
                            <a href="#" class="hover:text-green-600"><i class="fas fa-copy mr-1"></i> Duplicate</a>
                        </div>
                    </div>
                </div>
            `).join('');

            contentArea.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-semibold">Manage Surveys</h2>
                        <p class="text-gray-500">Create, edit, and manage all survey and assessment templates.</p>
                    </div>
                    <button class="bg-green-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-700 transition-all shadow-md">
                        <i class="fas fa-plus mr-2"></i>Create Survey
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${surveyCards}
                </div>
            `;
        }

        /**
         * Renders the team members list view.
         * (RESTORED FUNCTION)
         */
        function renderTeamMembers() {
            state.currentView = 'team';
            state.currentProjectId = null;
            pageTitle.textContent = 'Team Dashboard';
            addProjectBtn.classList.add('hidden');
            setActiveLink(teamLink);

            const teamCards = teamMembers.map(member => {
                const assignmentItems = member.assignments.map(assign => {
                    const project = projects.find(p => p.id === assign.projectId);
                    if (!project) return ''; // Skip if project not found (data integrity)
                    
                    return `
                        <div class_id="team-assignment-item" class="list-item-card grid grid-cols-10 gap-4 items-center px-4 py-3 border-b cursor-pointer" data-project-id="${project.id}">
                            <div class="col-span-3 font-semibold text-gray-800">${project.landowner}</div>
                            <div class="col-span-2 text-sm text-gray-600">${project.county}</div>
                            <div class="col-span-3 text-sm text-gray-600">${project.actionType}</div>
                            <div class="col-span-2">
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${assignmentStatusStyles[assign.status] || 'bg-gray-100 text-gray-800'}">${assign.status}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                const assignmentHeader = `
                    <div class="px-4 py-2 bg-gray-50 grid grid-cols-10 gap-4 text-xs font-bold text-gray-500 uppercase rounded-t-lg mt-4">
                        <div class="col-span-3">Assigned Landowner</div>
                        <div class="col-span-2">County</div>
                        <div class="col-span-3">Action Type</div>
                        <div class="col-span-2">Assignment Status</div>
                    </div>
                `;

                return `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <!-- Team Member Header -->
                        <div classs="team-member-header" class="p-4 border-b">
                            <h3 class="text-xl font-semibold">${member.name}</h3>
                            <div class="flex flex-wrap items-center text-sm text-gray-500 gap-x-6 gap-y-1 mt-1">
                                <span><i class="fas fa-user-tie w-4 mr-2 text-gray-400"></i>${member.role}</span>
                                <span><i class="fas fa-envelope w-4 mr-2 text-gray-400"></i>${member.email}</span>
                                <span><i class="fas fa-phone w-4 mr-2 text-gray-400"></i>${member.phone}</span>
                            </div>
                        </div>
                        
                        <!-- Assignments List -->
                        <div class="assignments-list">
                            ${member.assignments.length > 0 ? assignmentHeader : ''}
                            <div class="max-h-60 overflow-y-auto">
                                ${member.assignments.length > 0 ? assignmentItems : '<p class="text-sm text-gray-500 p-4 text-center">No projects currently assigned.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    ${teamCards}
                </div>
            `;
        }

        /**
         * Renders the main Tasks page.
         * (NEW FUNCTION)
         */
        function renderTasksPage() {
            state.currentView = 'tasks';
            state.currentProjectId = null;
            pageTitle.textContent = 'Tasks';
            setActiveLink(tasksLink);
            searchInput.classList.remove('hidden'); // Show search for the lists
            addProjectBtn.classList.add('hidden'); // Hide "New Project" unless needed

            // Create tab structure
            contentArea.innerHTML = `
                <div class="mb-4 border-b border-gray-200">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="tasks-tabs">
                        <li class="mr-2">
                            <button class="tasks-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="actions">
                                <i class="fas fa-tasks mr-2"></i>Conversation Actions
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="tasks-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="assessments">
                                <i class="fas fa-clipboard-check mr-2"></i>Conversation Assessments
                            </button>
                        </li>
                    </ul>
                </div>
                <div id="tasks-content">
                    <!-- Content will be injected here -->
                </div>
            `;

            // Set active tab and render content
            updateTasksView(state.tasksView);
        }

        /**
         * Updates the Tasks page to show the selected tab's content
         * (NEW FUNCTION)
         */
        function updateTasksView(view) {
            state.tasksView = view;
            
            // Update tab styles
            document.querySelectorAll('.tasks-tab').forEach(tab => {
                if (tab.dataset.view === view) {
                    tab.classList.add('border-green-600', 'text-green-600');
                    tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                } else {
                    tab.classList.remove('border-green-600', 'text-green-600');
                    tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                }
            });

            // Render content based on view
            if (view === 'actions') {
                searchInput.classList.remove('hidden');
                addProjectBtn.classList.remove('hidden'); // Show "New Project" on this tab
                renderTasksActionsList();
            } else {
                searchInput.classList.add('hidden'); // Hide search for assessment cards
                addProjectBtn.classList.add('hidden');
                renderTasksAssessmentsList();
            }
        }

        /**
         * Renders the actions list for the Tasks page.
         * (Duplicates logic from renderProjectList)
         * (NEW FUNCTION)
         */
        function renderTasksActionsList() {
            const tasksContent = document.getElementById('tasks-content');
            if (!tasksContent) return;

            // This is the same filtering logic as the dashboard
            const filteredProjects = projects.filter(p => 
                p.landowner.toLowerCase().includes(state.filterText.toLowerCase()) ||
                p.actionType.toLowerCase().includes(state.filterText.toLowerCase()) ||
                p.county.toLowerCase().includes(state.filterText.toLowerCase())
            );

            if (filteredProjects.length === 0) {
                tasksContent.innerHTML = `<div class="text-center py-16"><i class="fas fa-folder-open fa-3x text-gray-400 mb-4"></i><h2 class="text-xl font-semibold text-gray-600">No projects found.</h2><p class="text-gray-500">Try adjusting your search.</p></div>`;
                return;
            }

            // This is the same header as the dashboard
            const projectListHeader = `
                <div class="px-4 py-2 bg-gray-50 grid grid-cols-10 gap-4 text-xs font-bold text-gray-500 uppercase rounded-t-lg">
                    <div class="col-span-3">Landowner</div>
                    <div class="col-span-2">County</div>
                    <div class="col-span-3">Action Type</div>
                    <div class="col-span-2">Status</div>
                </div>
            `;

            // This is the same item list as the dashboard, using data-project-id
            const projectListItems = filteredProjects.map(p => `
                <div class="list-item-card bg-white px-4 py-3 grid grid-cols-10 gap-4 items-center border-b border-l-4 border-transparent cursor-pointer transition-all" data-project-id="${p.id}">
                    <div class="col-span-3 font-semibold text-gray-800">${p.landowner}</div>
                    <div class="col-span-2 text-sm text-gray-600">${p.county}</div>
                    <div class="col-span-3 text-sm text-gray-600 flex items-center">
                        <i class="${iconMap[p.actionType] || 'fas fa-leaf'} mr-3 text-gray-400 w-4 text-center"></i>
                        ${p.actionType}
                    </div>
                    <div class="col-span-2">
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusStyles[p.status] || 'bg-gray-100 text-gray-800'}">${p.status}</span>
                    </div>
                </div>
            `).join('');

            tasksContent.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    ${projectListHeader}
                    <div class="max-h-[75vh] overflow-y-auto">
                        ${projectListItems}
                    </div>
                </div>`;
        }
        
        /**
         * Renders the assessments list for the Tasks page.
         * (Duplicates logic from renderSurveysPage)
         * (NEW FUNCTION)
         */
        function renderTasksAssessmentsList() {
            const tasksContent = document.getElementById('tasks-content');
            if (!tasksContent) return;

            // This is the same card-rendering logic as renderSurveysPage
            const surveyCards = surveyTemplates.map(template => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col hover:shadow-lg transition-shadow">
                    <div class="flex-grow">
                        <div class="flex items-center text-green-600 mb-3">
                            <i class="fas ${template.icon || 'fa-poll'} fa-lg mr-3"></i>
                            <h3 class="font-bold text-lg text-gray-800">${template.name}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">${template.description}</p>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500 pt-4 border-t">
                        <span>${template.questionCount} Questions</span>
                        <div>
                            <a href="#" class="hover:text-green-600 mr-3"><i class="fas fa-edit mr-1"></i> Edit</a>
                            <a href="#" class="hover:text-green-600"><i class="fas fa-copy mr-1"></i> Duplicate</a>
                        </div>
                    </div>
                </div>
            `).join('');

            tasksContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-semibold">Manage Assessment Templates</h2>
                        <p class="text-gray-500">Create, edit, and manage all survey and assessment templates.</p>
                    </div>
                    <button class="bg-green-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-700 transition-all shadow-md">
                        <i class="fas fa-plus mr-2"></i>Create Template
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${surveyCards}
                </div>
            `;
        }


        /**
         * Renders the Mind Map/Project Structure page
         * (This function was in the user's file, but I am replacing it with the tabbed home page)
         */
        // function renderMindmapPage() { ... } // This is now part of renderOverviewStructureContent

        // --- MODAL FUNCTIONS ---
        // (RESTORED FUNCTIONS)

        function openCommunicationModal(filterType) {
            const modal = document.getElementById('communication-modal');
            
            let options = [];
            let filterLabel = '';
            if (filterType === 'county') {
                filterLabel = 'County';
                const counties = [...new Set(projects.map(p => p.county))];
                options = counties.map(c => `<option value="${c}">${c}</option>`);
            } else {
                filterLabel = 'Action Type';
                const actionTypes = [...new Set(projects.map(p => p.actionType))];
                options = actionTypes.map(a => `<option value="${a}">${a}</option>`);
            }

            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-8 m-4">
                    <h2 class="text-2xl font-bold mb-6">Bulk Communication</h2>
                    <form id="communication-form">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Channel</label>
                                <div class="flex rounded-md shadow-sm">
                                    <button type="button" id="comm-channel-email" class="channel-btn relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 bg-green-100 border-green-500 text-green-700">
                                        <i class="fas fa-envelope mr-2"></i> Email
                                    </button>
                                    <button type="button" id="comm-channel-whatsapp" class="channel-btn -ml-px relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                                        <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                                    </button>
                                </div>
                            </div>
                             <div>
                                <label for="comm-filter" class="block text-sm font-medium text-gray-700">Target Landowners By ${filterLabel}</label>
                                <select id="comm-filter" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="all">All ${filterLabel}s</option>
                                    ${options.join('')}
                                </select>
                             </div>
                        </div>
                        <div class="mt-6">
                             <label for="comm-message" class="block text-sm font-medium text-gray-700">Message</label>
                             <textarea id="comm-message" rows="6" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Dear Landowner..."></textarea>
                        </div>

                        <div class="flex justify-end space-x-3 mt-8">
                            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('communication-modal')">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold">Send Message</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('flex');
            modal.classList.remove('hidden');

            // Add event listeners for the channel switcher
            const emailBtn = modal.querySelector('#comm-channel-email');
            const whatsappBtn = modal.querySelector('#comm-channel-whatsapp');
            emailBtn.addEventListener('click', () => {
                emailBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                whatsappBtn.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
            });
            whatsappBtn.addEventListener('click', () => {
                whatsappBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                emailBtn.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
            });

            document.getElementById('communication-form').onsubmit = handleSendMessage;
        }

        function openNewProjectModal() {
            const modal = document.getElementById('new-project-modal');
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 m-4">
                    <h2 class="text-2xl font-bold mb-6">Create New Project</h2>
                    <form id="new-project-form">
                        <div class="mb-4">
                            <label for="landowner" class="block text-sm font-medium text-gray-700">Landowner Name</label>
                            <input type="text" id="landowner" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div class="mb-4">
                                <label for="county" class="block text-sm font-medium text-gray-700">County</label>
                                <input type="text" id="county" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="mb-4">
                                <label for="eircode" class="block text-sm font-medium text-gray-700">Eircode</label>
                                <input type="text" id="eircode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="A12 B3C4">
                            </div>
                        </div>
                         <div class="mb-4">
                            <label for="actionType" class="block text-sm font-medium text-gray-700">Action Type</label>
                            <select id="actionType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                <option>Fencing</option>
                                <option>Blocking Drains</option>
                                <option>Woodland</option>
                                <option>Sphagnum Moss</option>
                                <option>Hedgerow</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="details" class="block text-sm font-medium text-gray-700">Project Details</label>
                            <textarea id="details" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('new-project-modal')">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Create Project</button>
                        </div>
                    </form>
                </div>`;
            modal.classList.add('flex');
            modal.classList.remove('hidden');
            document.getElementById('new-project-form').onsubmit = handleAddProject;
        }

        function openAssessmentModal() {
            const modal = document.getElementById('assessment-modal');
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 m-4">
                    <h2 class="text-2xl font-bold mb-6">Add On-Site Assessment</h2>
                    <form id="assessment-form">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="assessor" class="block text-sm font-medium text-gray-700">Assessor</label>
                                <input type="text" id="assessor" required value="Maria Garcia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="assessment-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="assessment-date" required value="${new Date().toISOString().slice(0,10)}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="notes" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="mb-6 flex items-center justify-between p-3 bg-gray-50 rounded-md">
                             <label for="photos" class="text-sm font-medium text-gray-700">Attach Photos</label>
                             <input type="file" id="photos" multiple class="text-sm text-gray-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('assessment-modal')">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Submit Assessment</button>
                        </div>
                    </form>
                </div>`;
            modal.classList.add('flex');
            modal.classList.remove('hidden');
            document.getElementById('assessment-form').onsubmit = handleAddAssessment;
        }
        
        function openSurveyModal(isCompletion = false) {
             const project = projects.find(p => p.id === state.currentProjectId);
             const modal = document.getElementById('survey-modal');
             modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-xl p-8 m-4">
                    <h2 class="text-2xl font-bold mb-2">Participant Survey</h2>
                    <p class="text-sm text-gray-500 mb-6">This form simulates the experience for landowner ${project.landowner}.</p>
                    <form id="survey-form">
                        <div class="mb-4">
                            <p class="block text-sm font-medium text-gray-700 mb-2">Overall, how satisfied are you with the program?</p>
                            <div class="flex space-x-2 text-3xl cursor-pointer" id="satisfaction-rating">
                                <i class="far fa-star text-gray-300" data-value="1"></i>
                                <i class="far fa-star text-gray-300" data-value="2"></i>
                                <i class="far fa-star text-gray-300" data-value="3"></i>
                                <i class="far fa-star text-gray-300" data-value="4"></i>
                                <i class="far fa-star text-gray-300" data-value="5"></i>
                            </div>
                            <input type="hidden" id="satisfaction" required>
                        </div>
                         <div class="mb-6">
                            <label for="feedback" class="block text-sm font-medium text-gray-700">Do you have any feedback to help us improve?</label>
                            <textarea id="feedback" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('survey-modal')">Close</button>
                            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Submit Survey</button>
                        </div>
                    </form>
                </div>`;
            modal.classList.add('flex');
            modal.classList.remove('hidden');

            const stars = modal.querySelectorAll('#satisfaction-rating i');
            stars.forEach(star => {
                star.addEventListener('click', (e) => {
                    const rating = e.target.dataset.value;
                    document.getElementById('satisfaction').value = rating;
                    stars.forEach(s => {
                        s.classList.toggle('fas', s.dataset.value <= rating);
                        s.classList.toggle('text-yellow-400', s.dataset.value <= rating);
                        s.classList.toggle('far', s.dataset.value > rating);
                        s.classList.toggle('text-gray-300', s.dataset.value > rating);
                    });
                });
            });
            document.getElementById('survey-form').onsubmit = handleAddSurvey;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function showToast() {
            const toast = document.getElementById('toast-notification');
            toast.classList.remove('opacity-0', '-translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-10');
            }, 3000);
        }

        // --- HANDLER FUNCTIONS ---
        // (RESTORED FUNCTIONS)

        function handleSendMessage(e) {
            e.preventDefault();
            // In a real app, this would trigger a backend process
            console.log('Sending message:', {
                filter: document.getElementById('comm-filter').value,
                message: document.getElementById('comm-message').value,
            });
            closeModal('communication-modal');
            showToast();
        }

        function handleAddProject(e) {
            e.preventDefault();
            const newProject = {
                id: projects.length + 1,
                landowner: document.getElementById('landowner').value,
                county: document.getElementById('county').value,
                eircode: document.getElementById('eircode').value.toUpperCase(),
                phone: `35387${Math.floor(1000000 + Math.random() * 9000000)}`,
                actionType: document.getElementById('actionType').value,
                status: 'Application Review',
                startDate: new Date().toISOString().slice(0,10),
                specialist: 'N/A',
                details: document.getElementById('details').value,
                assessments: [],
                survey: { status: 'Not Sent', data: null },
                activityLog: [
                    { date: new Date().toISOString().slice(0,10), activity: 'Landowner submitted application.' }
                ]
            };
            projects.unshift(newProject);
            closeModal('new-project-modal');
            renderDashboard();
        }

        function handleAddAssessment(e) {
             e.preventDefault();
             const project = projects.find(p => p.id === state.currentProjectId);
             const newAssessment = {
                assessor: document.getElementById('assessor').value,
                date: document.getElementById('assessment-date').value,
                notes: document.getElementById('notes').value,
                photos: document.getElementById('photos').files.length,
                location: '52.14, -9.52' // Mock location
             };
             project.assessments.unshift(newAssessment);
             logActivity(project.id, `On-site assessment completed by ${newAssessment.assessor}.`);
             closeModal('assessment-modal');
             renderProjectDetail(project.id);
        }
        
        function handleAddSurvey(e) {
            e.preventDefault();
            const project = projects.find(p => p.id === state.currentProjectId);
            project.survey.status = 'Complete';
            project.survey.data = {
                satisfaction: parseInt(document.getElementById('satisfaction').value),
                feedback: document.getElementById('feedback').value,
            };
            logActivity(project.id, 'Participant survey completed.');
            if(project.status === 'Data Collection'){
                 project.status = 'Complete';
            }
            closeModal('survey-modal');
            renderProjectDetail(project.id);
        }

        function sendSurvey(projectId) {
            const project = projects.find(p => p.id === projectId);
            project.survey.status = 'Pending';
            logActivity(projectId, 'Participant survey sent to landowner.');
            renderProjectDetail(projectId);
        }
        
        function logActivity(projectId, activity) {
            const project = projects.find(p => p.id === projectId);
            project.activityLog.unshift({
                date: new Date().toISOString().slice(0,10),
                activity: activity,
            });
        }
        
        function navigateToProject(projectId) {
            renderProjectDetail(projectId);
        }

        function navigateToDashboard() {
            renderDashboard();
        }

        // --- HANDLER FUNCTIONS ---
        function handleLogin(e) {
            e.preventDefault();
            // In a real app, you'd validate credentials here
            console.log('Login successful');
            loginPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            // Initialize the app by rendering the home page
            renderOverviewPage();
        }

        function handleLogout() {
            appContainer.classList.add('hidden');
            loginPage.classList.remove('hidden');
            // Optional: Clear password field for security
            document.getElementById('password').value = "";
        }

        // --- EVENT LISTENERS ---
        function initAppEventListeners() {
            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                renderOverviewPage();
            });

            dashboardLink.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToDashboard();
            });

            // NEW: Tasks link listener
            tasksLink.addEventListener('click', (e) => {
                e.preventDefault();
                renderTasksPage();
            });

            surveysLink.addEventListener('click', (e) => {
                e.preventDefault();
                renderSurveysPage();
            });
            
            addProjectBtn.addEventListener('click', openNewProjectModal);

            searchInput.addEventListener('keyup', (e) => {
                state.filterText = e.target.value;
                if (state.currentView === 'dashboard' && state.dashboardView === 'list') {
                    renderProjectList();
                }
                if (state.currentView === 'tasks' && state.tasksView === 'actions') {
                    renderTasksActionsList();
                }
            });

            // Event delegation for dynamically added elements
            contentArea.addEventListener('click', (e) => {
                // Check for project list item click
                const projectCard = e.target.closest('.list-item-card');
                if (projectCard && projectCard.dataset.projectId) {
                    e.preventDefault();
                    navigateToProject(parseInt(projectCard.dataset.projectId));
                    return; // Stop further checks
                }

                // Check for "Back to Dashboard" button (from mindmap page)
                const backBtn = e.target.closest('#back-to-dashboard-btn');
                if (backBtn) {
                    e.preventDefault();
                    renderDashboard();
                }

                // Check for dashboard tab clicks
                const tabBtn = e.target.closest('.dashboard-tab');
                if (tabBtn) {
                    e.preventDefault();
                    updateDashboardView(tabBtn.dataset.view);
                }

                // Check for overview tab clicks
                const overviewTabBtn = e.target.closest('.overview-tab');
                if (overviewTabBtn) {
                    e.preventDefault();
                    updateOverviewView(overviewTabBtn.dataset.view);
                }

                // NEW: Check for tasks tab clicks
                const tasksTabBtn = e.target.closest('.tasks-tab');
                if (tasksTabBtn) {
                    e.preventDefault();
                    updateTasksView(tasksTabBtn.dataset.view);
                }
            });


            // Communication sidebar links
            implementationLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Placeholder: Renders the main dashboard. This can be built out.
                renderDashboard();
                updateDashboardView('list');
            });

            assessmentsLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Placeholder: Renders the surveys page, as assessments are a type of survey.
                renderSurveysPage();
            });

            communicationLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Defaults to 'county' filter, can be changed to a general comms page
                openCommunicationModal('county');
            });

            // Team Members sidebar links
            teamLink.addEventListener('click', (e) => {
                e.preventDefault();
                renderTeamMembers();
            });

            // --- NEW LOGIN LISTENERS ---
            logoutBtn.addEventListener('click', handleLogout);


            // Sidebar collapsible sections - MODIFIED FOR EVENT DELEGATION
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('.collapsible-btn');
                if (button) {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('i.fa-chevron-down');

                    if (content && icon) {
                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                        } else {
                            content.classList.add('hidden');
                            icon.classList.remove('rotate-180');
                        }
                    }
                }
            });

            // Close modals with Escape key
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal('new-project-modal');
                    closeModal('assessment-modal');
                    closeModal('survey-modal');
                    closeModal('communication-modal');
                }
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Select all elements once the DOM is loaded
            contentArea = document.getElementById('content-area');
            pageTitle = document.getElementById('page-title');
            searchInput = document.getElementById('search-input');
            homeLink = document.getElementById('home-link');
            dashboardLink = document.getElementById('dashboard-link');
            tasksLink = document.getElementById('tasks-link'); // NEW
            addProjectBtn = document.getElementById('add-project-btn');
            surveysLink = document.getElementById('surveys-link');
            implementationLink = document.getElementById('implementation-link');
            assessmentsLink = document.getElementById('assessments-link');
            communicationLink = document.getElementById('communication-link');
            teamLink = document.getElementById('team-link');
            loginPage = document.getElementById('login-page');
            appContainer = document.getElementById('app');
            loginForm = document.getElementById('login-form');
            logoutBtn = document.getElementById('logout-btn');

            // Set up the login form listener
            loginForm.addEventListener('submit', handleLogin);
            
            // Set up all app event listeners
            initAppEventListeners();
        });
    </script>
</body>
</html>

